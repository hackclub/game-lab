name: Check Plagiarism

on:
  pull_request:
    paths:
      - '**.js'

jobs:
  plagiarism_check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install glob

      - name: Trim JavaScript files
        run: |
          const fs = require('fs');
          const path = require('path');
          const glob = require('glob');
          const patterns = [/setLegend\(`.*?`\);/gs, /map\(`.*?`\);/gs, /bitmap\(`.*?`\);/gs];

          if (!fs.existsSync('temp')) { 
            fs.mkdirSync('temp'); 
          }

          glob.sync('**/*.js', { ignore: 'node_modules/**' }).forEach(file => {
            let content = fs.readFileSync(file, 'utf8');
            patterns.forEach(pattern => { 
              content = content.replace(pattern, ''); 
            });
            
            const tempFilePath = `temp/trimmed_${path.basename(file)}`;
            fs.writeFileSync(tempFilePath, content);
          });
        shell: node {0}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install compare50
        run: pip install compare50

      - name: Clone reference repository
        run: git clone https://github.com/hackclub/sprig.git

      - name: Run compare50
        run: |
          import subprocess
          import glob

          trimmed_files = glob.glob('temp/*.js')  # Adjust the path if your files are located differently
          result = subprocess.run(['compare50', *trimmed_files, 'sprig/games/'], capture_output=True, text=True)

          print(result.stdout)
        shell: python {0}